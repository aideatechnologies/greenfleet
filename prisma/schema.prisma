generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlserver"
}

// ============================================================
// Better Auth tables — String cuid() IDs (required by Better Auth)
// ============================================================

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sessions    Session[]
  accounts    Account[]
  members     Member[]
  invitations Invitation[]
  emissionConversionConfigs EmissionConversionConfig[]
  carlists           Carlist[]
  carlistVehicleAdds CarlistVehicle[]
  vehicleDocuments   VehicleDocument[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?

  userId               String
  user                 User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  activeOrganizationId String?

  @@index([userId])
  @@index([activeOrganizationId])
  @@map("sessions")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("accounts")
}

model Verification {
  id         String    @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt

  @@map("verifications")
}

// Organization plugin tables (Organization = Tenant)

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logo      String?
  metadata  String?
  createdAt DateTime @default(now())

  isActive Boolean @default(true)
  isDemo   Boolean @default(false)

  members        Member[]
  invitations    Invitation[]
  tenantFeatures TenantFeature[]

  @@map("organizations")
}

model Member {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  role           String
  createdAt      DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@map("members")
}

model Invitation {
  id             String   @id @default(cuid())
  email          String
  inviterId      String
  organizationId String
  role           String
  status         String
  expiresAt      DateTime
  createdAt      DateTime @default(now())

  inviter      User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("invitations")
}

// ============================================================
// Domain tables — Int autoincrement IDs, all snake_case
// ============================================================

// Feature toggle per tenant
model TenantFeature {
  id         BigInt      @id @default(autoincrement())
  tenantId   String   @map("tenant_id")
  featureKey String   @map("feature_key")
  enabled    Boolean  @default(false)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, featureKey])
  @@index([tenantId], map: "idx_tenant_features_tenant_id")
  @@map("tenant_features")
}

// Catalogo Veicoli Globale (no tenantId — condiviso tra tutti i tenant)
model CatalogVehicle {
  id                   BigInt       @id @default(autoincrement())
  codiceInfocarData    String?   @unique @map("codice_infocardata")
  marca                String
  modello              String
  allestimento         String?
  carrozzeria          String?
  normativa            String?
  capacitaSerbatoioL   Float?    @map("capacita_serbatoio_l")
  isHybrid             Boolean   @default(false) @map("is_hybrid")
  prezzoListino        Float?    @map("prezzo_listino")
  source               String    @default("INFOCARDATA")
  imageUrl             String?   @map("image_url")
  codiceAllestimento   String?   @map("codice_allestimento")
  annoImmatricolazione Int?      @map("anno_immatricolazione")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  lastSyncAt           DateTime? @map("last_sync_at")

  engines        Engine[]
  tenantVehicles TenantVehicle[]
  carlistEntries CarlistVehicle[]

  @@index([marca, modello])
  @@index([codiceInfocarData])
  @@map("catalog_vehicles")
}

model Engine {
  id                     BigInt      @id @default(autoincrement())
  catalogVehicleId       BigInt      @map("catalog_vehicle_id")
  nucmot                 String?
  fuelType               String   @map("fuel_type")
  cilindrata             Int?
  potenzaKw              Float?   @map("potenza_kw")
  potenzaCv              Float?   @map("potenza_cv")
  co2GKm                 Float?   @map("co2_g_km")
  co2Standard            String   @default("WLTP") @map("co2_standard")
  co2GKmWltp             Float?   @map("co2_g_km_wltp")
  co2GKmNedc             Float?   @map("co2_g_km_nedc")
  co2GKmWltpIsCalculated Boolean  @default(false) @map("co2_g_km_wltp_is_calculated")
  co2GKmNedcIsCalculated Boolean  @default(false) @map("co2_g_km_nedc_is_calculated")
  conversionConfigId     BigInt?     @map("conversion_config_id")
  consumptionL100Km      Float?   @map("consumption_l_100km")
  consumptionUnit        String   @default("L/100KM") @map("consumption_unit")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  catalogVehicle   CatalogVehicle            @relation(fields: [catalogVehicleId], references: [id], onDelete: Cascade)
  conversionConfig EmissionConversionConfig? @relation(fields: [conversionConfigId], references: [id])

  @@index([catalogVehicleId])
  @@index([fuelType])
  @@map("engines")
}

// Configurazione conversione emissioni WLTP <-> NEDC (globale)
model EmissionConversionConfig {
  id               BigInt      @id @default(autoincrement())
  name             String
  nedcToWltpFactor Float    @map("nedc_to_wltp_factor")
  wltpToNedcFactor Float    @map("wltp_to_nedc_factor")
  isDefault        Boolean  @default(false) @map("is_default")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  createdById      String   @map("created_by_id")

  createdBy User     @relation(fields: [createdById], references: [id])
  engines   Engine[]

  @@map("emission_conversion_configs")
}

// Fasce Car List (tenant-scoped)
model CarTier {
  id          BigInt      @id @default(autoincrement())
  tenantId    String   @map("tenant_id")
  name        String   @db.NVarChar(100)
  description String?  @db.NVarChar(500)
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  employees Employee[]

  @@unique([tenantId, name], map: "uq_car_tier_tenant_name")
  @@index([tenantId], map: "idx_car_tiers_tenant_id")
  @@map("car_tiers")
}

// Dipendenti (tenant-scoped)
model Employee {
  id           BigInt      @id @default(autoincrement())
  tenantId     String   @map("tenant_id")
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  email        String?
  phone        String?
  fiscalCode   String?  @map("fiscal_code")
  employeeCode String?  @map("employee_code")
  matricola    String?  @db.NVarChar(50)
  workLocation String?  @map("work_location")
  carTierId    BigInt?     @map("car_tier_id")
  carlistId    BigInt?     @map("carlist_id")
  isPool       Boolean  @default(false) @map("is_pool")
  type         String   @default("employee") @map("type")
  isActive     Boolean  @default(true) @map("is_active")
  avgMonthlyKm Float?   @map("avg_monthly_km")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  carTier            CarTier?           @relation(fields: [carTierId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  carlist            Carlist?           @relation(fields: [carlistId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenantVehicles     TenantVehicle[]
  vehicleAssignments VehicleAssignment[]
  fuelCards          FuelCard[]

  @@index([tenantId], map: "idx_employees_tenant_id")
  @@index([tenantId, fiscalCode], map: "idx_employees_tenant_fiscal_code")
  @@index([tenantId, employeeCode], map: "idx_employees_tenant_employee_code")
  @@index([tenantId, matricola], map: "idx_employees_tenant_matricola")
  @@map("employees")
}

// Veicoli operativi del tenant (flotta aziendale)
model TenantVehicle {
  id                 BigInt      @id @default(autoincrement())
  tenantId           String   @map("tenant_id")
  catalogVehicleId   BigInt      @map("catalog_vehicle_id")
  licensePlate       String   @map("license_plate")
  registrationDate   DateTime @map("registration_date")
  status             String   @default("ACTIVE") @map("status")
  assignedEmployeeId BigInt?     @map("assigned_employee_id")
  notes              String?
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  vin            String?  @map("vin")
  fringeBenefit  Float?   @map("fringe_benefit")

  catalogVehicle   CatalogVehicle    @relation(fields: [catalogVehicleId], references: [id])
  assignedEmployee Employee?         @relation(fields: [assignedEmployeeId], references: [id])
  assignments      VehicleAssignment[]
  contracts        Contract[]
  plateHistory     LicensePlateHistory[]
  fuelRecords      FuelRecord[]
  kmReadings       KmReading[]
  documents        VehicleDocument[]
  fuelCards        FuelCard[]

  @@unique([tenantId, licensePlate])
  @@index([tenantId], map: "idx_tenant_vehicles_tenant_id")
  @@index([catalogVehicleId], map: "idx_tenant_vehicles_catalog_vehicle_id")
  @@map("tenant_vehicles")
}

// Assegnazioni veicolo-dipendente (tenant-scoped)
model VehicleAssignment {
  id         BigInt       @id @default(autoincrement())
  tenantId   String    @map("tenant_id")
  vehicleId  BigInt       @map("vehicle_id")
  employeeId BigInt       @map("employee_id")
  startDate  DateTime  @map("start_date")
  endDate    DateTime? @map("end_date")
  notes      String?
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  vehicle  TenantVehicle @relation(fields: [vehicleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  employee Employee      @relation(fields: [employeeId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([tenantId], map: "idx_vehicle_assignments_tenant_id")
  @@index([vehicleId], map: "idx_vehicle_assignments_vehicle_id")
  @@index([employeeId], map: "idx_vehicle_assignments_employee_id")
  @@map("vehicle_assignments")
}

// Contratti veicoli (STI, tenant-scoped)
model Contract {
  id        BigInt      @id @default(autoincrement())
  tenantId  String   @map("tenant_id")
  vehicleId BigInt      @map("vehicle_id")
  type      String   @map("type")
  status    String   @default("ACTIVE") @map("status")
  notes     String?
  closedAt  DateTime? @map("closed_at")

  // Campi generali contratto
  contractNumber String   @map("contract_number")
  contractKm     Int?     @map("contract_km")
  supplierId     BigInt?     @map("supplier_id")
  durationMonths Int?     @map("duration_months")
  totalKm        Int?     @map("total_km")
  financialRate  Float?   @map("financial_rate")
  serviceRate    Float?   @map("service_rate")
  ownershipTax   Float?   @map("ownership_tax")
  taxRecurrence  String?  @map("tax_recurrence")
  allocationCode String?  @map("allocation_code")

  // Proprietario fields
  purchaseDate  DateTime? @map("purchase_date")
  purchasePrice Float?    @map("purchase_price")
  residualValue Float?    @map("residual_value")

  // Shared fields (Breve/Lungo Termine + Leasing)
  supplier  String?
  startDate DateTime? @map("start_date")
  endDate   DateTime? @map("end_date")

  // Breve Termine
  dailyRate  Float? @map("daily_rate")
  includedKm Int?   @map("included_km")

  // Lungo Termine + Leasing shared
  monthlyRate Float? @map("monthly_rate")

  // Lungo Termine specific
  franchiseKm      Int?    @map("franchise_km")
  extraKmPenalty   Float?  @map("extra_km_penalty")
  includedServices String? @map("included_services")

  // Leasing Finanziario specific
  leasingCompany String? @map("leasing_company")
  buybackValue   Float?  @map("buyback_value")
  maxDiscount    Float?  @map("max_discount")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  vehicle     TenantVehicle @relation(fields: [vehicleId], references: [id])
  supplierRef Supplier?     @relation(fields: [supplierId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([tenantId], map: "idx_contracts_tenant_id")
  @@index([vehicleId], map: "idx_contracts_vehicle_id")
  @@index([type], map: "idx_contracts_type")
  @@index([status], map: "idx_contracts_status")
  @@index([supplierId], map: "idx_contracts_supplier_id")
  @@map("contracts")
}

// Tipi Fornitore (tenant-scoped)
model SupplierType {
  id          BigInt      @id @default(autoincrement())
  tenantId    String   @map("tenant_id")
  code        String   @db.NVarChar(50)
  label       String   @db.NVarChar(100)
  description String?  @db.NVarChar(500)
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  suppliers Supplier[]

  @@unique([tenantId, code], map: "uq_supplier_type_tenant_code")
  @@index([tenantId], map: "idx_supplier_types_tenant_id")
  @@map("supplier_types")
}

// Fornitori (tenant-scoped)
model Supplier {
  id             BigInt      @id @default(autoincrement())
  tenantId       String   @map("tenant_id")
  supplierTypeId BigInt      @map("supplier_type_id")
  name           String   @db.NVarChar(200)
  vatNumber      String   @map("vat_number") @db.NVarChar(20)
  address        String?  @db.NVarChar(500)
  pec            String?  @db.NVarChar(100)
  contactName    String?  @map("contact_name") @db.NVarChar(100)
  contactPhone   String?  @map("contact_phone") @db.NVarChar(50)
  contactEmail   String?  @map("contact_email") @db.NVarChar(100)
  notes          String?  @db.NVarChar(1000)
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  supplierType SupplierType @relation(fields: [supplierTypeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  contracts    Contract[]
  fuelCards    FuelCard[]
  xmlTemplates SupplierXmlTemplate[]
  regexPresets FieldRegexPreset[]

  @@unique([tenantId, vatNumber], map: "uq_supplier_tenant_vat")
  @@index([tenantId], map: "idx_suppliers_tenant_id")
  @@index([supplierTypeId], map: "idx_suppliers_supplier_type_id")
  @@map("suppliers")
}

// Carte carburante (tenant-scoped)
model FuelCard {
  id                 BigInt       @id @default(autoincrement())
  tenantId           String    @map("tenant_id")
  cardNumber         String    @map("card_number") @db.NVarChar(50)
  supplierId         BigInt       @map("supplier_id")
  expiryDate         DateTime? @map("expiry_date")
  status             String    @default("ACTIVE")
  assignmentType     String    @map("assignment_type")
  assignedVehicleId  BigInt?      @map("assigned_vehicle_id")
  assignedEmployeeId BigInt?      @map("assigned_employee_id")
  notes              String?   @db.NVarChar(500)
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  supplier         Supplier       @relation(fields: [supplierId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  assignedVehicle  TenantVehicle? @relation(fields: [assignedVehicleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  assignedEmployee Employee?      @relation(fields: [assignedEmployeeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  fuelRecords      FuelRecord[]

  @@unique([tenantId, cardNumber], map: "uq_fuel_card_tenant_number")
  @@index([tenantId], map: "idx_fuel_cards_tenant_id")
  @@index([status], map: "idx_fuel_cards_status")
  @@index([assignedVehicleId], map: "idx_fuel_cards_vehicle_id")
  @@index([assignedEmployeeId], map: "idx_fuel_cards_employee_id")
  @@map("fuel_cards")
}

// Storico targhe veicolo (tenant-scoped)
model LicensePlateHistory {
  id          BigInt       @id @default(autoincrement())
  tenantId    String    @map("tenant_id")
  vehicleId   BigInt       @map("vehicle_id")
  plateNumber String    @map("plate_number")
  startDate   DateTime  @map("start_date")
  endDate     DateTime? @map("end_date")
  notes       String?
  createdAt   DateTime  @default(now()) @map("created_at")

  vehicle TenantVehicle @relation(fields: [vehicleId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([tenantId], map: "idx_license_plate_history_tenant_id")
  @@index([vehicleId], map: "idx_license_plate_history_vehicle_id")
  @@index([plateNumber], map: "idx_license_plate_history_plate_number")
  @@map("license_plate_history")
}

// Rifornimenti carburante (tenant-scoped)
model FuelRecord {
  id             BigInt      @id @default(autoincrement())
  tenantId       String   @map("tenant_id")
  vehicleId      BigInt      @map("vehicle_id")
  userId         String   @map("user_id")
  fuelCardId     BigInt      @map("fuel_card_id")
  date           DateTime
  fuelType       String   @map("fuel_type")
  quantityLiters Float    @map("quantity_liters")
  quantityKwh    Float?   @map("quantity_kwh")
  amountEur      Float    @map("amount_eur")
  odometerKm     Int      @map("odometer_km")
  notes          String?
  source         String   @default("MANUAL")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  vehicle  TenantVehicle @relation(fields: [vehicleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  fuelCard FuelCard      @relation(fields: [fuelCardId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([tenantId], map: "idx_fuel_records_tenant_id")
  @@index([vehicleId, date], map: "idx_fuel_records_vehicle_date")
  @@index([vehicleId, odometerKm], map: "idx_fuel_records_vehicle_km")
  @@index([fuelCardId], map: "idx_fuel_records_fuel_card_id")
  @@map("fuel_records")
}

// Audit trail legacy (tenant-scoped)
model AuditEntry {
  id         BigInt      @id @default(autoincrement())
  tenantId   String   @map("tenant_id")
  userId     String   @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  changes    String
  source     String?
  timestamp  DateTime @default(now())

  @@index([tenantId], map: "idx_audit_entries_tenant_id")
  @@index([entityType, entityId], map: "idx_audit_entries_entity")
  @@index([timestamp], map: "idx_audit_entries_timestamp")
  @@map("audit_entries")
}

// Audit trail completo (tenant-scoped)
model AuditLog {
  id         BigInt      @id @default(autoincrement())
  action     String
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  tenantId   String   @map("tenant_id")
  userId     String   @map("user_id")
  userName   String   @map("user_name")
  timestamp  DateTime @default(now())
  changes    String
  metadata   String?

  @@index([tenantId, timestamp], map: "idx_audit_logs_tenant_timestamp")
  @@index([entityType, entityId], map: "idx_audit_logs_entity")
  @@index([userId, timestamp], map: "idx_audit_logs_user_timestamp")
  @@map("audit_logs")
}

// Metriche giornaliere per-tenant (tenant-scoped)
model TenantMetrics {
  id              BigInt      @id @default(autoincrement())
  tenantId        String   @map("tenant_id")
  date            DateTime
  queryCount      Int      @default(0) @map("query_count")
  storageBytes    BigInt   @default(0) @map("storage_bytes")
  activeUsers     Int      @default(0) @map("active_users")
  vehicleCount    Int      @default(0) @map("vehicle_count")
  fuelRecordCount Int      @default(0) @map("fuel_record_count")
  createdAt       DateTime @default(now()) @map("created_at")

  @@unique([tenantId, date], map: "uq_tenant_metrics_tenant_date")
  @@index([tenantId, date], map: "idx_tenant_metrics_tenant_date")
  @@map("tenant_metrics")
}

// Carlist — raggruppamenti veicoli (tenant-scoped)
model Carlist {
  id          BigInt      @id @default(autoincrement())
  tenantId    String   @map("tenant_id")
  name        String   @db.NVarChar(100)
  description String?  @db.NVarChar(500)
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  vehicles        CarlistVehicle[]
  employees       Employee[]
  creator         User              @relation(fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  emissionTargets EmissionTarget[]

  @@unique([tenantId, name], map: "uq_carlist_tenant_name")
  @@index([tenantId], map: "idx_carlist_tenant_id")
  @@map("carlists")
}

// Relazione N:M esplicita Carlist-CatalogVehicle
model CarlistVehicle {
  id               BigInt      @id @default(autoincrement())
  carlistId        BigInt      @map("carlist_id")
  catalogVehicleId BigInt      @map("catalog_vehicle_id")
  addedAt          DateTime @default(now()) @map("added_at")
  addedBy          String   @map("added_by")

  carlist        Carlist        @relation(fields: [carlistId], references: [id], onDelete: Cascade)
  catalogVehicle CatalogVehicle @relation(fields: [catalogVehicleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  adder          User           @relation(fields: [addedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([carlistId, catalogVehicleId], map: "uq_carlist_catalog_vehicle")
  @@index([carlistId], map: "idx_carlist_vehicle_carlist_id")
  @@index([catalogVehicleId], map: "idx_carlist_vehicle_catalog_vehicle_id")
  @@map("carlist_vehicles")
}

// Documenti veicolo (tenant-scoped)
model VehicleDocument {
  id            BigInt      @id @default(autoincrement())
  tenantId      String   @map("tenant_id")
  vehicleId     BigInt      @map("vehicle_id")
  documentType  String   @map("document_type")
  description   String?
  expiryDate    DateTime @map("expiry_date")
  fileName      String   @map("file_name")
  fileUrl       String   @map("file_url")
  fileMimeType  String   @map("file_mime_type")
  fileSize      Int      @map("file_size")
  createdBy     String   @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  vehicle TenantVehicle @relation(fields: [vehicleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  creator User          @relation(fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([tenantId], map: "idx_vehicle_documents_tenant_id")
  @@index([vehicleId], map: "idx_vehicle_documents_vehicle_id")
  @@index([expiryDate], map: "idx_vehicle_documents_expiry_date")
  @@map("vehicle_documents")
}

// Rilevazioni chilometriche dedicate (tenant-scoped)
model KmReading {
  id         BigInt      @id @default(autoincrement())
  tenantId   String   @map("tenant_id")
  vehicleId  BigInt      @map("vehicle_id")
  userId     String   @map("user_id")
  date       DateTime
  odometerKm Int      @map("odometer_km")
  notes      String?
  source     String   @default("MANUAL")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  vehicle TenantVehicle @relation(fields: [vehicleId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([tenantId], map: "idx_km_readings_tenant_id")
  @@index([vehicleId, date], map: "idx_km_readings_vehicle_date")
  @@index([vehicleId, odometerKm], map: "idx_km_readings_vehicle_km")
  @@map("km_readings")
}

// Macro Tipi Carburante (globale)
model MacroFuelType {
  id        BigInt      @id @default(autoincrement())
  name      String   @unique @db.NVarChar(100)
  scope     Int
  unit      String   @db.NVarChar(10)
  color     String   @default("#6366f1") @map("color") @db.NVarChar(9)
  sortOrder Int      @default(0) @map("sort_order")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  fuelTypeMappings FuelTypeMacroMapping[]
  emissionFactors  EmissionFactor[]

  @@index([scope], map: "idx_macro_fuel_types_scope")
  @@map("macro_fuel_types")
}

// Mappatura FuelType veicolo → MacroFuelType (globale)
model FuelTypeMacroMapping {
  id              BigInt    @id @default(autoincrement())
  vehicleFuelType String @map("vehicle_fuel_type")
  macroFuelTypeId BigInt    @map("macro_fuel_type_id")
  scope           Int
  description     String @default("") @map("description") @db.NVarChar(100)

  macroFuelType MacroFuelType @relation(fields: [macroFuelTypeId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([vehicleFuelType, scope], map: "uq_fuel_type_macro_mapping_fuel_scope")
  @@index([vehicleFuelType], map: "idx_fuel_type_macro_mapping_fuel_type")
  @@index([macroFuelTypeId], map: "idx_fuel_type_macro_mapping_macro_id")
  @@map("fuel_type_macro_mappings")
}

// GWP per gas Kyoto (globale)
model GwpConfig {
  id        BigInt      @id @default(autoincrement())
  gasName   String   @map("gas_name") @db.NVarChar(10)
  gwpValue  Float    @map("gwp_value")
  source    String   @db.NVarChar(100)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([gasName, source], map: "uq_gwp_config_gas_source")
  @@index([isActive], map: "idx_gwp_config_active")
  @@map("gwp_configs")
}

// Fattori di emissione per-gas per MacroFuelType (globale)
model EmissionFactor {
  id              BigInt      @id @default(autoincrement())
  macroFuelTypeId BigInt?     @map("macro_fuel_type_id")
  co2             Float    @default(0)
  ch4             Float    @default(0)
  n2o             Float    @default(0)
  hfc             Float    @default(0)
  pfc             Float    @default(0)
  sf6             Float    @default(0)
  nf3             Float    @default(0)
  source          String   @db.NVarChar(100)
  effectiveDate   DateTime @map("effective_date")
  createdBy       String   @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Colonne legacy
  fuelType String? @map("fuel_type")
  value    Float?

  macroFuelType MacroFuelType? @relation(fields: [macroFuelTypeId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([fuelType, effectiveDate], map: "idx_emission_factors_fuel_type_date")
  @@index([macroFuelTypeId, effectiveDate], map: "idx_emission_factors_macro_date")
  @@map("emission_factors")
}

// Target emissioni (tenant-scoped)
model EmissionTarget {
  id          BigInt      @id @default(autoincrement())
  tenantId    String   @map("tenant_id")
  scope       String
  carlistId   BigInt?     @map("carlist_id")
  targetValue Float    @map("target_value")
  period      String
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  description String?  @db.NVarChar(500)
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  carlist     Carlist? @relation(fields: [carlistId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([tenantId, scope, period], map: "idx_emission_targets_tenant_scope_period")
  @@index([carlistId], map: "idx_emission_targets_carlist")
  @@map("emission_targets")
}

// Template estrazione XML (tenant-scoped)
model SupplierXmlTemplate {
  id              BigInt      @id @default(autoincrement())
  tenantId        String   @map("tenant_id")
  supplierId      BigInt      @map("supplier_id")
  name            String   @db.NVarChar(200)
  description     String?  @db.NVarChar(500)
  templateConfig  String   @map("template_config") @db.NVarChar(Max)
  matchingConfig  String?  @map("matching_config") @db.NVarChar(Max)
  sampleXml       String?  @map("sample_xml") @db.NVarChar(Max)
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  supplier       Supplier        @relation(fields: [supplierId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  invoiceImports InvoiceImport[]

  @@index([tenantId], map: "idx_xml_templates_tenant_id")
  @@index([supplierId], map: "idx_xml_templates_supplier_id")
  @@map("supplier_xml_templates")
}

// Import fatture XML (tenant-scoped)
model InvoiceImport {
  id                   BigInt       @id @default(autoincrement())
  tenantId             String    @map("tenant_id")
  templateId           BigInt       @map("template_id")
  userId               String    @map("user_id")
  fileName             String    @map("file_name") @db.NVarChar(255)
  fileHash             String?   @map("file_hash") @db.NVarChar(64)
  supplierVatNumber    String?   @map("supplier_vat_number") @db.NVarChar(20)
  invoiceNumber        String?   @map("invoice_number") @db.NVarChar(50)
  invoiceDate          DateTime? @map("invoice_date")
  status               String    @default("PENDING")
  totalLinesExtracted  Int       @default(0) @map("total_lines_extracted")
  totalLinesMatched    Int       @default(0) @map("total_lines_matched")
  totalLinesCreated    Int       @default(0) @map("total_lines_created")
  totalLinesSkipped    Int       @default(0) @map("total_lines_skipped")
  totalLinesError      Int       @default(0) @map("total_lines_error")
  requireManualConfirm Boolean   @default(false) @map("require_manual_confirm")
  processingLog        String?   @map("processing_log") @db.NVarChar(Max)
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  completedAt          DateTime? @map("completed_at")

  template SupplierXmlTemplate @relation(fields: [templateId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  lines    InvoiceImportLine[]

  @@index([tenantId], map: "idx_invoice_imports_tenant_id")
  @@index([status], map: "idx_invoice_imports_status")
  @@index([fileHash], map: "idx_invoice_imports_file_hash")
  @@map("invoice_imports")
}

// Righe importate da fatture XML (tenant-scoped)
model InvoiceImportLine {
  id                  BigInt       @id @default(autoincrement())
  tenantId            String    @map("tenant_id")
  importId            BigInt       @map("import_id")
  lineNumber          Int       @map("line_number")
  licensePlate        String?   @map("license_plate") @db.NVarChar(50)
  date                DateTime?
  fuelType            String?   @map("fuel_type") @db.NVarChar(50)
  quantity            Float?
  amount              Float?
  cardNumber          String?   @map("card_number") @db.NVarChar(50)
  odometerKm          Int?      @map("odometer_km")
  description         String?   @db.NVarChar(500)
  rawXml              String?   @map("raw_xml") @db.NVarChar(Max)
  matchStatus         String    @default("UNMATCHED") @map("match_status")
  matchedFuelRecordId BigInt?      @map("matched_fuel_record_id")
  createdFuelRecordId BigInt?      @map("created_fuel_record_id")
  matchScore          Float?    @map("match_score")
  matchDetails        String?   @map("match_details") @db.NVarChar(Max)
  resolvedVehicleId   BigInt?      @map("resolved_vehicle_id")
  extractionErrors    String?   @map("extraction_errors") @db.NVarChar(Max)
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  import InvoiceImport @relation(fields: [importId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_import_lines_tenant_id")
  @@index([importId], map: "idx_import_lines_import_id")
  @@index([matchStatus], map: "idx_import_lines_match_status")
  @@map("invoice_import_lines")
}

// Preset filtri report emissioni (tenant-scoped)
model ReportFilterPreset {
  id          BigInt      @id @default(autoincrement())
  tenantId    String   @map("tenant_id")
  name        String
  filters     String   @map("filters")
  createdById String   @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("report_filter_presets")
}

// Preset regex per estrazione campi XML (tenant-scoped)
model FieldRegexPreset {
  id          BigInt      @id @default(autoincrement())
  tenantId    String   @map("tenant_id")
  supplierId  BigInt?     @map("supplier_id")
  fieldName   String   @map("field_name") @db.NVarChar(50)
  name        String   @db.NVarChar(200)
  patterns    String   @db.NVarChar(Max)
  priority    Int      @default(0)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  supplier    Supplier? @relation(fields: [supplierId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([tenantId, fieldName], map: "idx_regex_presets_tenant_field")
  @@index([supplierId], map: "idx_regex_presets_supplier_id")
  @@map("field_regex_presets")
}
